/*!
 * Tree graph with HTML5 and JavaScript.
 * Date: Sep 17, 2012.
 * Dependencies: none.
 * Source: https://github.com/rodrigocfd/html5-tree-graph
 *
 * Copyright (c) 2012 Rodrigo Cesar de Freitas Dias
 * Released under the MIT license, see license.txt for details.
 */
;function TreeGraph(b){var h={xBoxPadding:4,yNodePadding:5,xMinPadding:30,yBranchGap:10,xBezierRadius:14,imgSize:22,font:"10pt Arial",bgColor:"rgba(255,255,255,0.5)",textColor:"#121212",borderColor:"#888",lineColor:"#AAA",animateTime:100,storageKey:"TreeGraph_"+b};var f={retObj:{},context:document.getElementById(b).getContext("2d"),rootNode:null,callbacks:{Click:null,CtrlClick:null},isRendering:false,isDragging:false,baseDragPos:null};var l={AddPropertiesIfNotExist:function g(p,n){if(p===undefined){p={}}for(var q in n){if(p[q]===undefined){if(n[q]!==null&&typeof n[q]==="object"){if(n[q] instanceof Array){p[q]=[];for(var o=0;o<n[q].length;++o){p[q].push(g({},n[q]))}}else{g(p[q],n[q])}}else{p[q]=n[q]}}}return p},GetPos:function(o){var n={x:o.offsetLeft,y:o.offsetTop};while(o.offsetParent){if(o===document.getElementsByTagName("body")[0]){break}else{n.x+=o.offsetParent.offsetLeft;n.y+=o.offsetParent.offsetTop;o=o.offsetParent}}return n},CalcTextRect:function k(o,q){if(k.cache===undefined){k.cache=[]}if(k.cache[o.font]===undefined){var p=document.createElement("span"),n=document.getElementsByTagName("body")[0];p.style.font=o.font;p.textContent="gM";n.appendChild(p);k.cache[o.font]=p.offsetHeight;n.removeChild(p)}return{cx:o.measureText(q).width+h.xBoxPadding*2,cy:k.cache[o.font]}},DrawRect:function(p,o,t,n,s,r,q){o+=0.5;t+=0.5;p.save();if(r!==undefined&&r!==null){p.strokeStyle=r}p.beginPath();p.rect(o,t,n,s);if(q!==undefined&&q!==null){p.fillStyle=q;p.fill()}p.stroke();p.restore()},DrawBezier:function(p,o,r,n,q){p.beginPath();p.moveTo(o,r);p.bezierCurveTo(o+h.xBezierRadius,r,n-h.xBezierRadius,q,n,q);p.stroke()},DrawHalfCircle:function(o,n,p){o.beginPath();o.arc(n,p,4,Math.PI*0.5,Math.PI*1.5,true);o.stroke()},Animate:function(p,s,n){var r=window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame;var o=window.mozAnimationStartTime||Date.now();var q=function(v){var t=(v||Date.now())-o;var u=t/p;if(u>1){u=1}s.call(window,u);if(u<1){r(q)}else{if(n!==undefined&&n!==null){n.call(window)}}};r(q)}};var j={FlushToStorage:function(){function n(q){var o={text:q.text,isExpanded:q.isExpanded,pos:{x:q.rect.x,y:q.rect.y},children:[]};for(var p=0;p<q.children.length;++p){o.children.push(n(q.children[p]))}return o}localStorage.setItem(h.storageKey,JSON.stringify(n(f.rootNode)))},CheckStorage:function(){var n=null;if(localStorage.getItem(h.storageKey)!==null){function p(r,q){if(r===null||q===null){return false}else{if(r.text!==q.text||r.children.length!==q.children.length){return false}else{for(var s=0;s<r.children.length;++s){if(!p(r.children[s],q.children[s])){return false}}}}return true}n=JSON.parse(localStorage.getItem(h.storageKey));if(p(f.rootNode,n)){function o(s,r){s.isExpanded=r.isExpanded;for(var q=0;q<s.children.length;++q){o(s.children[q],r.children[q])}}o(f.rootNode,n)}else{n=null;j.FlushToStorage()}}else{j.FlushToStorage()}return n},Load:function(o){f.context.save();f.context.font=h.font;f.rootNode=o;j.Init();var n=j.CheckStorage();j.LoadImages(function(){var q=j.VisibleMatrix();i.Calc(q);if(n!==null){function t(w,v){w.posSch={x:v.pos.x,y:v.pos.y};for(var u=0;u<w.children.length;++u){t(w.children[u],v.children[u])}}if(n.pos.x==0&&n.pos.y==0){i.ResetRootPos(q)}else{t(f.rootNode,n)}}else{i.ResetRootPos(q)}j.Render(q);var s=["mousedown","mouseup","mouseout","mousemove","click","selectstart"];var p=[m.MouseDown,m.MouseUp,m.MouseOut,m.MouseMove,m.Click,m.SelectStart];for(var r=0;r<s.length;++r){f.context.canvas.removeEventListener(s[r],p[r]);f.context.canvas.addEventListener(s[r],p[r])}f.context.restore()})},Init:function d(){if(d.seq===undefined){d.seq=0}function n(r,s,q){l.AddPropertiesIfNotExist(r,{text:"(NO TEXT)",children:[],color:h.bgColor,image:null,data:null});r.id=d.seq++;r.parent=function(){return q};r.depth=s;r.isExpanded=false;r.imageObj=null;var p=l.CalcTextRect(f.context,r.text);r.rect={x:0,y:0,cx:p.cx,cy:p.cy};r.posSch=null;r.posTmp=null;for(var o=0;o<r.children.length;++o){n(r.children[o],s+1,r)}}n(f.rootNode,0,null)},LoadImages:function(p){var q=0;function n(s){q+=(s.image===null)?0:1;for(var r=0;r<s.children.length;++r){n(s.children[r])}}function o(t){function s(u){if(u.type==="error"){console.log("Failed to load "+u.target.src+'".')}if(--q===0&&p!==undefined){p()}}if(t.image!==null){t.imageObj=new Image();t.imageObj.src=t.image;t.imageObj.onload=function(u){t.rect.cx+=(h.imgSize!==null?h.imgSize:t.imageObj.width)+1;t.rect.cy=Math.max(t.rect.cy,(h.imgSize!==null?h.imgSize:t.imageObj.height)+1);s(u)};t.imageObj.onerror=function(u){t.imageObj=null;s(u)}}for(var r=0;r<t.children.length;++r){o(t.children[r])}}n(f.rootNode);if(q===0){if(p!==undefined){p()}}else{o(f.rootNode)}},VisibleMatrix:function(){var o=[];function n(q){if(o[q.depth]===undefined){o[q.depth]=[]}o[q.depth].push(q);if(q.isExpanded){for(var p=0;p<q.children.length;++p){n(q.children[p])}}}if(f.rootNode!==null){n(f.rootNode)}return o},Count:function(){function n(p){var q=1;for(var o=0;o<p.children.length;++o){q+=n(p.children[o])}return q}return n(f.rootNode)},AtPoint:function(n,s,p){for(var q=0;q<p.length;++q){for(var o=0;o<p[q].length;++o){var r=p[q][o];if((n>=r.rect.x)&&(n<r.rect.x+r.rect.cx)&&(s>=r.rect.y)&&(s<r.rect.y+r.rect.cy+4)){return r}}}return null},CollapseAll:function(){if(f.isRendering){return}var n=j.VisibleMatrix();for(var p=0;p<n.length;++p){for(var o=0;o<n[p].length;++o){n[p][o].posSch={x:0,y:h.yNodePadding};n[p][o].isExpanded=false}}i.ResetRootPos(n);j.Render(n,function(){f.rootNode.isExpanded=false;n=j.VisibleMatrix();i.Calc(n);i.ResetRootPos(n);j.Render(n,function(){j.FlushToStorage()})})},ExpandAll:function(){if(f.isRendering){return}function o(q){if(q.children.length===0){return}q.isExpanded=true;for(var p=0;p<q.children.length;++p){o(q.children[p])}}o(f.rootNode);var n=j.VisibleMatrix();i.Calc(n);i.ResetRootPos(n);j.Render(n,function(){j.FlushToStorage()})},FitParentContainer:function(){f.context.canvas.style.width="100%";f.context.canvas.style.height="100%";f.context.canvas.width=f.context.canvas.offsetWidth;f.context.canvas.height=f.context.canvas.offsetHeight;j.Render(j.VisibleMatrix())},Paint:function(o,s){f.context.save();f.context.clearRect(0,0,f.context.canvas.width,f.context.canvas.height);f.context.font=h.font;f.context.textBaseline="middle";for(var p=0;p<o.length;++p){for(var n=0;n<o[p].length;++n){var r=o[p][n];r.posTmp={x:r.rect.x,y:r.rect.y};if(r.posSch!==null){r.posTmp.x+=(r.posSch.x-r.posTmp.x)*s;r.posTmp.y+=(r.posSch.y-r.posTmp.y)*s}f.context.save();f.context.strokeStyle=h.lineColor;var q=r.parent();if(q!==null){l.DrawBezier(f.context,q.posTmp.x+q.rect.cx,q.posTmp.y+q.rect.cy/2,r.posTmp.x,r.posTmp.y+r.rect.cy/2)}if(r.children.length>0&&!r.isExpanded){l.DrawHalfCircle(f.context,r.posTmp.x+r.rect.cx+1,r.posTmp.y+r.rect.cy/2+1)}f.context.restore();l.DrawRect(f.context,r.posTmp.x,r.posTmp.y,r.rect.cx,r.rect.cy,h.borderColor,r.color);if(r.imageObj!==null){if(h.imgSize!==null){f.context.drawImage(r.imageObj,r.posTmp.x+1,r.posTmp.y+1,h.imgSize,h.imgSize)}else{f.context.drawImage(r.imageObj,r.posTmp.x+1,r.posTmp.y+1)}}f.context.save();f.context.fillStyle=h.textColor;f.context.fillText(r.text,r.posTmp.x+h.xBoxPadding+(r.imageObj!==null?(h.imgSize!==null?h.imgSize:r.imageObj.width)+1:0),r.posTmp.y+r.rect.cy/2);f.context.restore()}}f.context.restore()},Render:function(o,n){function p(r){for(var s=0;s<r.length;++s){for(var q=0;q<r[s].length;++q){if(r[s][q].posSch!==null){return true}}}return false}if(f.isRendering){return}f.isRendering=true;if(p(o)){l.Animate(h.animateTime,function(q){j.Paint(o,q)},function(){for(var r=0;r<o.length;++r){for(var q=0;q<o[r].length;++q){var s=o[r][q];if(s.posSch!==null){s.rect.x=s.posSch.x;s.rect.y=s.posSch.y;s.posSch=null;s.posTmp=null}}}f.isRendering=false;if(n!==undefined){n()}})}else{j.Paint(o,1);f.isRendering=false;if(n!==undefined){n()}}}};var i={Calc:function(n){i.PreliminarPos(n);i.AdjustInternalNodes(n);i.IncreaseBranchGap(n[0][0]);i.AdjustHorizontally(n);return n},PreliminarPos:function(o){for(var p=0;p<o.length;++p){var r=0;for(var n=0;n<o[p].length;++n){var q=o[p][n];q.posSch={x:p*80,y:r+h.yNodePadding};r+=q.rect.cy+h.yNodePadding*2}}},AdjustInternalNodes:function(x){for(var q=x.length-2;q>=0;--q){var u=x[q];var v=-1;for(var w=0;w<u.length;++w){if(u[w].children.length>0&&u[w].isExpanded){i.AlignToChildren(u[w]);if(v==-1){var t=u[w].posSch.y-h.yNodePadding;for(var r=w-1;r>=0;--r){t-=u[r].rect.cy+2*h.yNodePadding;u[r].posSch.y=h.yNodePadding+t}}else{if(v>-1){var p=u[v].posSch.y+u[v].rect.cy+h.yNodePadding;var o=u[w].posSch.y-h.yNodePadding;var n=0;for(var r=v+1;r<w;++r){n+=u[r].rect.cy+2*h.yNodePadding}if(n>o-p){for(var r=w;r<u.length;++r){i.MoveNodesDown(u[r],n-(o-p))}}for(var r=v+1;r<w;++r){var s=(u[r].rect.cy+2*h.yNodePadding)/n;u[r].posSch.y=Math.round(p+s*Math.max(n,o-p)/2-u[r].rect.cy/2);p+=s*Math.max(n,o-p)}}}v=w}}if(v>-1){var t=u[v].posSch.y+u[v].rect.cy+h.yNodePadding;for(var r=v+1;r<u.length;++r){u[r].posSch.y=t+h.yNodePadding;t+=u[r].rect.cy+2*h.yNodePadding}}}},IncreaseBranchGap:function e(r){if(!r.isExpanded){return 0}var o=0;var s=true;for(var q=0;q<r.children.length;++q){var u=r.children[q];if(u.children.length&&u.isExpanded){if(s){s=false}else{for(var t=q;t<r.children.length;++t){i.MoveNodesDown(r.children[t],h.yBranchGap)}o+=h.yBranchGap}var p=e(u);for(var t=q+1;t<r.children.length;++t){i.MoveNodesDown(r.children[t],p)}o+=p}}i.AlignToChildren(r);return o},AdjustHorizontally:function(o){for(var r=1;r<o.length;++r){var q=o[r];if(!q.length){break}var s=0;var n=o[r-1];for(var p=0;p<n.length;++p){if(s<n[p].posSch.x+n[p].rect.cx+h.xMinPadding){s=n[p].posSch.x+n[p].rect.cx+h.xMinPadding}}for(var p=0;p<q.length;++p){q[p].posSch.x=s}}},AlignToChildren:function(p){if(p.children.length===0||!p.isExpanded){return}var n=p.children[0].posSch.y-h.yNodePadding;var o=p.children[p.children.length-1].posSch.y+p.children[p.children.length-1].rect.cy+h.yNodePadding;p.posSch.y=Math.round(n+(o-n)/2-p.rect.cy/2)},MoveNodesDown:function c(o,p){o.posSch.y+=p;if(o.isExpanded){for(var n=0;n<o.children.length;++n){c(o.children[n],p)}}},ResetRootPos:function(q){var o=q[0][0].posSch.x-Math.round(f.context.canvas.width/10);var n=q[0][0].posSch.y-Math.round(f.context.canvas.height/2-q[0][0].rect.cy/2);for(var r=0;r<q.length;++r){for(var p=0;p<q[r].length;++p){q[r][p].posSch.x-=o;q[r][p].posSch.y-=n}}return q}};var m={MouseDown:function(o){if(f.isRendering){return}var n=l.GetPos(f.context.canvas);f.baseDragPos={x:o.pageX-n.x,y:o.pageY-n.y};f.context.canvas.style.cursor="move";o.preventDefault()},MouseUp:function(o){if(f.baseDragPos!==null){window.setTimeout(function(){f.baseDragPos=null;f.isDragging=false;j.FlushToStorage()},40);var n=l.GetPos(f.context.canvas);f.context.canvas.style.cursor=j.AtPoint(o.pageX-n.x,o.pageY-n.y,j.VisibleMatrix())===null?"auto":"pointer";o.preventDefault()}},MouseOut:function(){if(f.baseDragPos!==null){f.baseDragPos=null;f.isDragging=false;j.FlushToStorage();f.context.canvas.style.cursor="auto"}},MouseMove:function a(r){if(f.isRendering){return}var q=l.GetPos(f.context.canvas);var u={x:r.pageX-q.x,y:r.pageY-q.y};var n=j.VisibleMatrix();if(f.baseDragPos===null){function s(w,v){if(w===null&&v===null){return true}if(w!==null||v!==null){return false}return w.id===v.id}if(a.prev===undefined){a.prev=null}var t=j.AtPoint(u.x,u.y,n);if(!s(t,a.prev)){a.prev=t;f.context.canvas.style.cursor=(t!==null)?"pointer":"auto"}}else{f.isDragging=true;for(var p=0;p<n.length;++p){for(var o=0;o<n[p].length;++o){n[p][o].rect.x+=u.x-f.baseDragPos.x;n[p][o].rect.y+=u.y-f.baseDragPos.y}}f.baseDragPos={x:u.x,y:u.y};j.Paint(n,1)}r.preventDefault()},Click:function(r){if(f.isRendering||f.isDragging){return}var q=l.GetPos(f.context.canvas);var n=j.VisibleMatrix(),p={x:r.pageX-q.x,y:r.pageY-q.y},t=j.AtPoint(p.x,p.y,n);if(t===null){return}if(r.ctrlKey){if(f.callbacks.CtrlClick!==null){f.callbacks.CtrlClick.call(f.retObj,t,r)}}else{if(t.children.length>0){function s(w,x,v){for(var u=0;u<w.children.length;++u){if(x!==null){w.children[u].rect.x=x.x;w.children[u].rect.y=x.y}if(v!==undefined&&v!==null){w.children[u].posSch={x:v.x,y:v.y}}s(w.children[u],x,v)}}function o(u,D,A,w){var C={x:u-(A.posSch!==null?A.posSch.x:A.rect.x)-(u-A.rect.x),y:D-(A.posSch!==null?A.posSch.y:A.rect.y)-(D-A.rect.y)};for(var z=0;z<w.length;++z){for(var v=0;v<w[z].length;++v){var B=w[z][v];if(B.posSch!==null){B.posSch.x+=C.x;B.posSch.y+=C.y}else{B.rect.x+=C.x;B.rect.y+=C.y}}}return w}if(!t.isExpanded){t.isExpanded=true;s(t,t.rect,null);n=j.VisibleMatrix();i.Calc(n);o(p.x,p.y,t,n);j.Render(n,function(){j.FlushToStorage();if(f.callbacks.Click!==null){f.callbacks.Click.call(f.retObj,t,r)}})}else{t.isExpanded=false;n=i.Calc(j.VisibleMatrix());t.isExpanded=true;s(t,null,t.posSch);n=j.VisibleMatrix();o(p.x,p.y,t,n);j.Render(n,function(){t.isExpanded=false;n=j.VisibleMatrix();i.Calc(n);o(p.x,p.y,t,n);j.Render(n,function(){j.FlushToStorage();if(f.callbacks.Click!==null){f.callbacks.Click.call(f.retObj,t,r)}})})}}else{if(f.callbacks.Click!==null){f.callbacks.Click.call(f.retObj,t,r)}}}},SelectStart:function(n){n.preventDefault()}};return l.AddPropertiesIfNotExist(f.retObj,{click:function(n){f.callbacks.Click=n;return f.retObj},ctrlClick:function(n){f.callbacks.CtrlClick=n;return f.retObj},load:function(n){j.Load(n);return f.retObj},collapseAll:function(){j.CollapseAll();return f.retObj},expandAll:function(){j.ExpandAll();return f.retObj},countNodes:function(){return j.Count()},redraw:function(){j.Render(j.VisibleMatrix());return f.retObj},clear:function(){f.context.clearRect(0,0,f.context.canvas.width,f.context.canvas.height);return f.retObj},fitParentContainer:function(){j.FitParentContainer();return f.retObj}})};